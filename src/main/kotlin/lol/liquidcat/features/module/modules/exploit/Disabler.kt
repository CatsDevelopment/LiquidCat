package lol.liquidcat.features.module.modules.exploit

import lol.liquidcat.event.EventTarget
import lol.liquidcat.event.PacketEvent
import lol.liquidcat.event.UpdateEvent
import lol.liquidcat.features.module.Module
import lol.liquidcat.features.module.ModuleCategory
import lol.liquidcat.utils.sendPacket
import lol.liquidcat.value.BoolValue
import lol.liquidcat.value.ListValue
import net.minecraft.entity.player.PlayerCapabilities
import net.minecraft.network.play.client.*
import net.minecraft.util.BlockPos
import java.util.*

class Disabler : Module("Disabler", "Disables some Anti-Cheats", ModuleCategory.EXPLOIT) {

    private val mode = ListValue("Mode", arrayOf("NoPayload", "Normal", "Spectate", "Riding", "InvalidPlace", "Flying"), "Normal")
    private val specRandom = BoolValue("SpectateRandomUUID", true)
    private val invalidRiding = BoolValue("InvalidRidingValues", false)

    override val tag: String
        get() = mode.get()

    // Credits: https://github.com/Rilshrink/Minecraft-Disablers/blob/main/Disabler.js

    @EventTarget
    fun onPacket(event: PacketEvent) {
        val packet = event.packet

        when (mode.get()) {
            "NoPayload" -> if (packet is C17PacketCustomPayload) event.cancelEvent()

            "Normal" -> if (packet is C0FPacketConfirmTransaction || packet is C00PacketKeepAlive)
                event.cancelEvent()

            "Spectate" -> if (packet is C03PacketPlayer)
                sendPacket(C18PacketSpectate(if (specRandom.get()) UUID.randomUUID() else mc.thePlayer.uniqueID))

            "Flying" -> if (packet is C03PacketPlayer) {
                val capabilities = PlayerCapabilities()

                capabilities.allowFlying = true
                capabilities.isFlying = true
                capabilities.flySpeed = Float.MAX_VALUE

                sendPacket(C13PacketPlayerAbilities(capabilities))
            }

            "Riding" ->	if (packet is C03PacketPlayer)
                sendPacket(
                    if (invalidRiding.get())
                        C0CPacketInput(Float.NaN, Float.NaN, !mc.thePlayer.movementInput.jump, !mc.thePlayer.movementInput.sneak)
                    else
                        C0CPacketInput(mc.thePlayer.moveStrafing, mc.thePlayer.moveForward, mc.thePlayer.movementInput.jump, mc.thePlayer.movementInput.sneak)
                )
        }
    }

    @EventTarget
    fun onUpdate(event: UpdateEvent) {
        if (mode.get() == "InvalidPlace")
            sendPacket(C08PacketPlayerBlockPlacement(BlockPos(
                Double.NaN, Double.NaN, Double.NaN), 1, null, Float.NaN, Float.NaN, Float.NaN))
    }
}
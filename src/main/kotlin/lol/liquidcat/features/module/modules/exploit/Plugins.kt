/*
 * LiquidCat Hacked Client
 * A free open source mixin-based injection hacked client for Minecraft using Minecraft Forge.
 * https://github.com/CatsDevelopment/LiquidCat
 */
package lol.liquidcat.features.module.modules.exploit

import lol.liquidcat.event.EventTarget
import lol.liquidcat.event.PacketEvent
import lol.liquidcat.event.UpdateEvent
import lol.liquidcat.features.module.Module
import lol.liquidcat.features.module.ModuleCategory
import lol.liquidcat.features.module.ModuleInfo
import net.ccbluex.liquidbounce.utils.ClientUtils
import net.ccbluex.liquidbounce.utils.timer.TickTimer
import net.minecraft.network.play.client.C14PacketTabComplete
import net.minecraft.network.play.server.S3APacketTabComplete

@ModuleInfo(
    "Plugins",
    "Allows you to see which plugins the server is using.",
    ModuleCategory.EXPLOIT
)
class Plugins : Module() {

    private val tickTimer = TickTimer()

    override fun onEnable() {
        mc.netHandler.addToSendQueue(C14PacketTabComplete("/"))
        tickTimer.reset()
    }

    @EventTarget
    fun onUpdate(event: UpdateEvent) {
        tickTimer.update()

        if (tickTimer.hasTimePassed(20)) {
            ClientUtils.displayChatMessage("\n§8(§9Plugins§8)§r Plugins check timed out...\n")

            tickTimer.reset()
            state = false
        }
    }

    @EventTarget
    fun onPacket(event: PacketEvent) {
        val packet = event.packet

        if (packet is S3APacketTabComplete) {
            val plugins = mutableListOf<String>()
            val commands = packet.func_149630_c()

            for (c in commands) {
                val command = c.split(":")

                if (command.size > 1) {
                    val plugin = command[0].removePrefix("/").capitalize()

                    if (!plugins.contains(plugin))
                        plugins.add(plugin)
                }
            }

            if (plugins.isNotEmpty()) {
                ClientUtils.displayChatMessage("\n§8(§9Plugins§8)§r A total of ${plugins.size} plugins found.")
                ClientUtils.displayChatMessage("§8(§9Plugins§8)§r Plugins:\n §7${plugins.joinToString("§8, §7")}\n")
            } else
                ClientUtils.displayChatMessage("\n§8(§9Plugins§8)§r No plugins found.\n")

            tickTimer.reset()
            state = false
        }
    }
}